name: Silea CI/CD with AWS Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  AWS_REGION: eu-west-3 # Paris region (closest to Morocco)
  ECR_BACKEND_REPOSITORY: silea-backend
  ECR_FRONTEND_REPOSITORY: silea-frontend
  ECS_CLUSTER: silea-cluster
  ECS_SERVICE_BACKEND: silea-backend-service
  ECS_SERVICE_FRONTEND: silea-frontend-service
  ECS_TASK_DEFINITION_BACKEND: silea-backend-task
  ECS_TASK_DEFINITION_FRONTEND: silea-frontend-task

jobs:
  # ============================================
  # Stage 1: Detect Changes
  # ============================================
  changes:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'Backend/**'
            frontend:
              - 'Frontend/**'

  # ============================================
  # Stage 2: Backend - Build & Test
  # ============================================
  backend:
    name: ‚òï Backend Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'push'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: silea_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: Backend/pom.xml

      - name: üî® Build & Test
        working-directory: Backend
        run: mvn clean verify -B
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/silea_test_db?useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: Backend/target/surefire-reports/
          retention-days: 7

      - name: üì¶ Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: Backend/target/*.jar
          retention-days: 1

  # ============================================
  # Stage 3: Frontend - Build & Lint
  # ============================================
  frontend:
    name: ‚öõÔ∏è Frontend Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: ‚¨¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: ''
          
      - name: üì¶ Install pnpm
        run: npm install -g pnpm@9

      - name:  Install dependencies
        working-directory: Frontend
        run: pnpm install --no-frozen-lockfile

      - name: üîç Lint
        working-directory: Frontend
        run: pnpm lint
        continue-on-error: true

      - name: üî® Build
        working-directory: Frontend
        run: pnpm build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080
          NEXT_TELEMETRY_DISABLED: 1

      - name: üì¶ Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            Frontend/.next/standalone
            Frontend/.next/static
            Frontend/public
          retention-days: 1

  # ============================================
  # Stage 4: Performance Testing (JMeter)
  # ============================================
  performance-test:
    name: üìä Performance Test
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'pull_request'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: silea_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      
      - name: üì• Download Backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: üöÄ Start Backend
        run: |
          java -jar backend-jar/*.jar &
          sleep 30
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/silea_test_db?useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword

      - name: üìä Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          
      - name: üîß Create JMeter Test Plan
        run: |
          cat > test-plan.jmx << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <jmeterTestPlan version="1.2" properties="5.0" jmeter="5.6.3">
            <hashTree>
              <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="Silea API Load Test">
                <elementProp name="TestPlan.user_defined_variables" elementType="Arguments">
                  <collectionProp name="Arguments.arguments"/>
                </elementProp>
              </TestPlan>
              <hashTree>
                <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="API Users">
                  <intProp name="ThreadGroup.num_threads">50</intProp>
                  <intProp name="ThreadGroup.ramp_time">10</intProp>
                  <longProp name="ThreadGroup.duration">60</longProp>
                  <boolProp name="ThreadGroup.scheduler">true</boolProp>
                  <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
                  <elementProp name="ThreadGroup.main_controller" elementType="LoopController">
                    <boolProp name="LoopController.continue_forever">false</boolProp>
                    <intProp name="LoopController.loops">-1</intProp>
                  </elementProp>
                </ThreadGroup>
                <hashTree>
                  <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Get Categories">
                    <stringProp name="HTTPSampler.domain">localhost</stringProp>
                    <stringProp name="HTTPSampler.port">8080</stringProp>
                    <stringProp name="HTTPSampler.path">/api/categories</stringProp>
                    <stringProp name="HTTPSampler.method">GET</stringProp>
                  </HTTPSamplerProxy>
                  <hashTree/>
                  <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Get Products">
                    <stringProp name="HTTPSampler.domain">localhost</stringProp>
                    <stringProp name="HTTPSampler.port">8080</stringProp>
                    <stringProp name="HTTPSampler.path">/api/products</stringProp>
                    <stringProp name="HTTPSampler.method">GET</stringProp>
                  </HTTPSamplerProxy>
                  <hashTree/>
                </hashTree>
              </hashTree>
            </hashTree>
          </jmeterTestPlan>
          EOF

      - name: üß™ Run JMeter Test
        run: |
          apache-jmeter-5.6.3/bin/jmeter -n -t test-plan.jmx -l results.jtl -j jmeter.log

      - name: üìä Generate HTML Report
        run: |
          apache-jmeter-5.6.3/bin/jmeter -g results.jtl -o report/

      - name: üì§ Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: report/
          retention-days: 7

      - name: üìà Performance Summary
        run: |
          echo "## üìä Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          awk -F',' 'NR>1 {requests++; sum+=$2} END {print "| Total Requests | " requests " |"; print "| Avg Response Time | " sum/requests " ms |"}' results.jtl >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 5: Build & Push Docker Images to ECR
  # ============================================
  docker:
    name: üê≥ Build & Push to ECR
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./Backend
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: üê≥ Build & Push Frontend
        uses: docker/build-push-action@v6
        with:
          context: ./Frontend
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.API_URL }}

  # ============================================
  # Stage 6: Deploy to AWS ECS
  # ============================================
  deploy:
    name: üöÄ Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üìù Fill Backend Task Definition
        id: task-def-backend
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/backend-task-definition.json
          container-name: silea-backend
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}

      - name: üöÄ Deploy Backend to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def-backend.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE_BACKEND }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: üìù Fill Frontend Task Definition
        id: task-def-frontend
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: .aws/frontend-task-definition.json
          container-name: silea-frontend
          image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}

      - name: üöÄ Deploy Frontend to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def-frontend.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE_FRONTEND }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: ‚úÖ Deployment Summary
        run: |
          echo "## üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Backend: \`${{ env.ECS_SERVICE_BACKEND }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Frontend: \`${{ env.ECS_SERVICE_FRONTEND }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tags:" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Stage 7: Security Scan
  # ============================================
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write
    
    steps:
      - uses: actions/checkout@v4

      - name: üîç Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: üì§ Upload to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
