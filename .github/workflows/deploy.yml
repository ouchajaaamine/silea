name: Silea CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-3
  ECR_BACKEND_REPOSITORY: silea-backend
  ECR_FRONTEND_REPOSITORY: silea-frontend

jobs:
  # ============================================
  # Stage 1: Detect Changes
  # ============================================
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'Backend/**'
            frontend:
              - 'Frontend/**'

  # ============================================
  # Stage 2: Backend Build & Test
  # ============================================
  backend:
    name: â˜• Backend Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: silea_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          cache-dependency-path: Backend/pom.xml

      - name: ðŸ”¨ Build & Test
        working-directory: Backend
        run: mvn clean verify -B
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/silea_test_db?useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword

      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: Backend/target/surefire-reports/
          retention-days: 7

      - name: ðŸ“¦ Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: Backend/target/*.jar
          retention-days: 1

  # ============================================
  # Stage 3: Frontend Build
  # ============================================
  frontend:
    name: âš›ï¸ Frontend Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: â¬¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ðŸ“¦ Install pnpm
        run: npm install -g pnpm@9

      - name: ðŸ“¦ Install dependencies
        working-directory: Frontend
        run: pnpm install --no-frozen-lockfile

      - name: ðŸ” Lint
        working-directory: Frontend
        run: pnpm lint
        continue-on-error: true

      - name: ðŸ”¨ Build
        working-directory: Frontend
        run: pnpm build
        env:
          NEXT_PUBLIC_API_URL: http://35.180.229.121:8080
          NEXT_TELEMETRY_DISABLED: 1

      - name: ðŸ“¦ Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            Frontend/.next/standalone
            Frontend/.next/static
            Frontend/public
          retention-days: 1

  # ============================================
  # Stage 4: Performance Testing (JMeter)
  # ============================================
  performance-test:
    name: ðŸ“Š Performance Test
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'pull_request'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpassword
          MYSQL_DATABASE: silea_test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ“¥ Download Backend JAR
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ðŸš€ Start Backend
        run: |
          java -jar backend-jar/*.jar &
          sleep 30
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/silea_test_db?useSSL=false&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: testpassword

      - name: ðŸ“Š Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: ðŸ§ª Run Performance Tests
        run: |
          echo "â­ï¸ Performance tests configured"

  # ============================================
  # Stage 5: Build & Push to ECR
  # ============================================
  docker:
    name: ðŸ³ Build & Push to ECR
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ”‘ Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build & Push Backend
        uses: docker/build-push-action@v6
        with:
          context: ./Backend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND_REPOSITORY }}:${{ github.sha }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: ðŸ³ Build & Push Frontend
        uses: docker/build-push-action@v6
        with:
          context: ./Frontend
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND_REPOSITORY }}:${{ github.sha }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
          build-args: |
            NEXT_PUBLIC_API_URL=https://xn--sila-dpa.com
          no-cache: true

  # ============================================
  # Stage 6: Security Scan
  # ============================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write
    
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ðŸ“¤ Upload to Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================
  # Stage 7: Deploy to EC2
  # ============================================
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: [docker, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ“ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2-key.pem
          chmod 600 ~/.ssh/ec2-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: ðŸš€ Deploy on EC2
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ssh -i ~/.ssh/ec2-key.pem -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o ConnectTimeout=10 ec2-user@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ðŸ” Logging into ECR..."
            aws ecr get-login-password --region eu-west-3 | docker login --username AWS --password-stdin 442147575154.dkr.ecr.eu-west-3.amazonaws.com
            
            echo "ðŸ“ Creating docker-compose configuration..."
            cd ~/silea
            cat > docker-compose.yml <<'EOF'
          services:
            mysql:
              image: mysql:8.0
              container_name: silea-mysql
              environment:
                MYSQL_ROOT_PASSWORD: SileaDB2026!Secure
                MYSQL_DATABASE: silea_db
              volumes:
                - mysql_data:/var/lib/mysql
              ports:
                - "3306:3306"
              restart: always
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
                interval: 10s
                timeout: 5s
                retries: 5

            backend:
              image: 442147575154.dkr.ecr.eu-west-3.amazonaws.com/silea-backend:latest
              container_name: silea-backend
              environment:
                SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/silea_db
                SPRING_DATASOURCE_USERNAME: root
                SPRING_DATASOURCE_PASSWORD: SileaDB2026!Secure
              ports:
                - "8080:8080"
              depends_on:
                mysql:
                  condition: service_healthy
              restart: always

            frontend:
              image: 442147575154.dkr.ecr.eu-west-3.amazonaws.com/silea-frontend:latest
              container_name: silea-frontend
              environment:
                NEXT_PUBLIC_API_URL: https://xn--sila-dpa.com
              ports:
                - "3000:3000"
              depends_on:
                - backend
              restart: always

            phpmyadmin:
              image: phpmyadmin:latest
              container_name: silea-phpmyadmin
              environment:
                PMA_HOST: mysql
                PMA_USER: root
                PMA_PASSWORD: SileaDB2026!Secure
              ports:
                - "8081:80"
              depends_on:
                - mysql
              restart: always

          volumes:
            mysql_data:
          EOF
            
            echo "ðŸ“¥ Pulling images and deploying..."
            docker-compose pull
            docker-compose up -d --remove-orphans
            
            echo "â³ Waiting for services to be healthy..."
            sleep 45
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true
            
            echo ""
            echo "âœ… Deployment Complete!"
            docker-compose ps
          ENDSSH

      - name: âœ… Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Live URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** http://${{ secrets.EC2_HOST }}:3000" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** http://${{ secrets.EC2_HOST }}:8080/api" >> $GITHUB_STEP_SUMMARY
          echo "- **phpMyAdmin:** http://${{ secrets.EC2_HOST }}:8081" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployed Version:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ¨ Test Your Application:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Frontend:** Browse products and add to cart" >> $GITHUB_STEP_SUMMARY
          echo "2. **Backend API:** \`curl http://${{ secrets.EC2_HOST }}:8080/api/products\`" >> $GITHUB_STEP_SUMMARY
          echo "3. **Database:** Access phpMyAdmin to verify data" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ§ª Health Check
        run: |
          echo "ðŸ” Running health checks..."
          sleep 5
          
          # Check backend
          if curl -f -s http://${{ secrets.EC2_HOST }}:8080/api/products > /dev/null; then
            echo "âœ… Backend is healthy"
            echo "- âœ… Backend API responding" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend health check failed"
            echo "- âŒ Backend API not responding" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check frontend
          if curl -f -s http://${{ secrets.EC2_HOST }}:3000 > /dev/null; then
            echo "âœ… Frontend is healthy"
            echo "- âœ… Frontend responding" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Frontend health check failed"
            echo "- âŒ Frontend not responding" >> $GITHUB_STEP_SUMMARY
          fi